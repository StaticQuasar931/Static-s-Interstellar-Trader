<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interstellar Trader</title>
    <style>
        /* Global Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1f2833;
            color: #c5c6c7;
            overflow-x: hidden;
        }
        /* Light Theme */
        body.light-theme {
            background-color: #ffffff;
            color: #1f2833;
        }
        /* Blue Theme */
        body.blue-theme {
            background-color: #0b0c10;
            color: #66fcf1;
        }
        /* Header */
        header {
            background-color: #0b0c10;
            padding: 10px;
            text-align: center;
            color: #66fcf1;
        }
        header.light-theme {
            background-color: #f1f1f1;
            color: #1f2833;
        }
        header.blue-theme {
            background-color: #1f2833;
            color: #66fcf1;
        }
        /* Main Content */
        #main-content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        /* Ship Container */
        #ship-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .ship {
            background-color: #0b0c10;
            padding: 15px;
            margin: 10px;
            width: 300px;
            border-radius: 8px;
            position: relative;
            cursor: pointer;
            user-select: none;
        }
        .ship.light-theme {
            background-color: #f1f1f1;
            color: #1f2833;
        }
        .ship.blue-theme {
            background-color: #1f2833;
            color: #66fcf1;
        }
        .ship:hover {
            background-color: #45a29e;
            color: #0b0c10;
        }
        .ship.light-theme:hover {
            background-color: #66fcf1;
            color: #0b0c10;
        }
        .ship.blue-theme:hover {
            background-color: #66fcf1;
            color: #0b0c10;
        }
        .ship .upgrade-count {
            position: absolute;
            top: 10px;
            right: 10px;
            font-weight: bold;
        }
        /* Buttons */
        .button {
            background-color: #45a29e;
            color: #0b0c10;
            border: none;
            padding: 10px 15px;
            margin: 5px 0;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
        }
        .button:hover {
            background-color: #66fcf1;
        }
        .button:disabled {
            background-color: #c5c6c7;
            color: #0b0c10;
            cursor: not-allowed;
        }
        /* Progress Bar */
        .progress-bar {
            background-color: #c5c6c7;
            width: 100%;
            height: 20px;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
            position: relative;
        }
        .progress {
            background-color: #45a29e;
            height: 100%;
            width: 0%;
        }
        .progress-time, .progress-earnings {
            position: absolute;
            top: 0;
            font-size: 12px;
            font-weight: bold;
            color: #0b0c10;
            text-shadow: 1px 1px 2px #c5c6c7;
        }
        .progress-time {
            left: 5px;
        }
        .progress-earnings {
            right: 5px;
        }
        /* Event Log */
        #event-log {
            background-color: #0b0c10;
            padding: 10px;
            margin: 20px auto;
            max-width: 800px;
            height: 200px;
            overflow-y: auto;
            border-radius: 8px;
        }
        #event-log.light-theme {
            background-color: #f1f1f1;
            color: #1f2833;
        }
        #event-log.blue-theme {
            background-color: #1f2833;
            color: #66fcf1;
        }
        #event-log p {
            margin: 5px 0;
            font-size: 14px;
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            background-color: #0b0c10;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            color: #c5c6c7;
            position: relative;
        }
        .modal-content.light-theme {
            background-color: #f1f1f1;
            color: #1f2833;
        }
        .modal-content.blue-theme {
            background-color: #1f2833;
            color: #66fcf1;
        }
        .close {
            color: #c5c6c7;
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: #66fcf1;
            text-decoration: none;
            cursor: pointer;
        }
        /* Top Right Buttons */
        .top-right-buttons {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            z-index: 1000;
        }
        .top-right-buttons .button {
            margin: 0;
        }
        /* Responsive Design */
        @media (max-width: 768px) {
            .ship {
                width: 90%;
            }
            .modal-content {
                width: 95%;
            }
            .event-log {
                width: 95%;
            }
            .top-right-buttons {
                flex-direction: column;
                top: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <header id="game-header">
        <h1>Interstellar Trader</h1>
    </header>

    <div id="main-content">
        <div class="top-right-buttons">
            <button class="button" id="help-button" onclick="toggleHelp()">‚ùì Help</button>
            <button class="button" id="settings-button" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
            <button class="button" id="share-button" onclick="shareGame()">üîó Share</button>
            <button class="button" id="buy-amount-button" onclick="toggleBuyAmount()">Buy: 1x</button>
        </div>

        <p id="credits-display">Credits: <span id="credits">100 üí∏</span></p>
        <p id="spaceship-display">Spaceships: 1/10 üöÄ</p>
        <p id="tech-level-display">Technology Level: 1 ‚ú®</p>
        <p id="rebirth-points-display">Rebirth Points: <span id="rebirth-points">0</span> ‚ôæÔ∏è</p>

        <div id="ship-container">
            <!-- Ships will be dynamically added here -->
        </div>

        <div id="action-buttons">
            <button class="button" onclick="buyShip()">üõí Buy a New Ship</button>
            <button class="button" onclick="sendAllShips()">üöÄ Send All Ships</button>
            <button class="button" onclick="toggleUpgradeMenu()">üõ†Ô∏è Upgrade Menu</button>
            <button class="button" onclick="toggleCombineShipsModal()">üîó Combine Ships</button>
            <button class="button" onclick="toggleCombineAllShipsModal()" id="combine-all-button">üåå Combine All Ships</button>
            <button class="button" onclick="toggleEmployeeMenu()">üë®‚ÄçüöÄ Employee Menu</button>
            <button class="button" onclick="confirmRebirth()">‚ôªÔ∏è Rebirth</button>
        </div>

        <div id="event-log">
            <!-- Event log messages will appear here -->
        </div>
    </div>

    <!-- Modals -->
    <!-- Upgrade Menu Modal -->
    <div id="upgrade-menu" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleUpgradeMenu()">&times;</span>
            <h3>Upgrade Menu</h3>
            <button class="button" onclick="buyUpgrade()">üîß Buy Upgrade</button>
            <p>Cost: <span id="upgrade-cost">100 üí∏</span></p>
            <button class="button" onclick="buyAutomation()">ü§ñ Buy Automation</button>
            <p>Cost: <span id="automation-cost">500 üí∏</span></p>
            <button class="button" onclick="buyMultiplier()">‚úñÔ∏è Buy Multiplier</button>
            <p>Cost: <span id="multiplier-cost">10,000 üí∏</span></p>
            <button class="button" onclick="buyBigUpgrade()">üöÄ Big Upgrade for Ship</button>
            <p>Cost: <span id="big-upgrade-cost">5,000 üí∏</span></p>
            <button class="button" onclick="upgradeShipLimit()">üìà Upgrade Ship Limit</button>
            <p>Cost: <span id="ship-limit-upgrade-cost">5,000 üí∏</span></p>
        </div>
    </div>

    <!-- Employee Menu Modal -->
    <div id="employee-menu" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleEmployeeMenu()">&times;</span>
            <h3>Employee Menu</h3>
            <button class="button" onclick="hireEmployee('storage')">üì¶ Hire Storage Employee</button>
            <p>Cost: <span id="storage-employee-cost">1,000 üí∏</span></p>
            <button class="button" onclick="hireEmployee('efficiency')">‚öôÔ∏è Hire Efficiency Employee</button>
            <p>Cost: <span id="efficiency-employee-cost">1,500 üí∏</span></p>
            <button class="button" onclick="hireEmployee('security')">üõ°Ô∏è Hire Security Employee</button>
            <p>Cost: <span id="security-employee-cost">2,000 üí∏</span></p>
        </div>
    </div>

    <!-- Combine Ships Modal -->
    <div id="combine-ships-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleCombineShipsModal()">&times;</span>
            <h3>Combine Ships</h3>
            <p>Select two ships to combine:</p>
            <div id="combine-ship-selection">
                <!-- Ship selection checkboxes will be added here -->
            </div>
            <p>Combination Cost: <span id="combine-cost">0 üí∏</span></p>
            <button class="button" onclick="confirmCombineShips()">Confirm</button>
        </div>
    </div>

    <!-- Combine All Ships Modal -->
    <div id="combine-all-ships-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleCombineAllShipsModal()">&times;</span>
            <h3>Combine All Ships</h3>
            <p>Are you sure you want to combine all your ships into one powerful ship?</p>
            <p>Combination Cost: <span id="combine-all-cost">0 üí∏</span></p>
            <button class="button" onclick="confirmCombineAllShips()">Confirm</button>
        </div>
    </div>

    <!-- Rebirth Confirmation Modal -->
    <div id="rebirth-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRebirthModal()">&times;</span>
            <h3>Confirm Rebirth</h3>
            <p id="rebirth-modal-text">Are you sure you want to rebirth? This will reset all your progress but grant you <strong>0</strong> Rebirth Points (RP).</p>
            <button class="button" onclick="rebirth()">Confirm</button>
        </div>
    </div>

    <!-- Share Confirmation Modal -->
    <div id="share-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeShareModal()">&times;</span>
            <h3>Share the Game</h3>
            <p>Share this link on your favorite platform to earn a bonus!</p>
            <div style="margin-bottom: 10px;">
                <a href="#" target="_blank" class="button" id="twitter-share">üê¶ Twitter</a>
                <a href="#" target="_blank" class="button" id="facebook-share">üìò Facebook</a>
                <a href="#" target="_blank" class="button" id="reddit-share">üëΩ Reddit</a>
                <a href="#" target="_blank" class="button" id="linkedin-share">üîó LinkedIn</a>
            </div>
            <p>Or copy the link below:</p>
            <input type="text" id="share-link" value="https://yourgameurl.com" readonly>
            <button class="button" onclick="copyShareLink()">üìã Copy Link</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleSettings()">&times;</span>
            <h3>Settings</h3>
            <button class="button" onclick="toggleTheme()">üåô Toggle Theme</button>
            <button class="button" onclick="saveGameManually()">üíæ Save Game</button>
            <button class="button" onclick="resetGame()">üóëÔ∏è Reset Game</button>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleHelp()">&times;</span>
            <h3>Help</h3>
            <p>Welcome to Interstellar Trader! Your goal is to build a trading empire across the galaxy.</p>
            <!-- Add detailed help content here -->
        </div>
    </div>

    <script>
        // ==================== GAME STATE ====================
        let gameState = {
            credits: 100,
            spaceshipCount: 1,
            techLevel: 1,
            rebirthPoints: 0,
            totalCreditsEarned: 100,
            multiplier: 1,
            ships: [],
            buyAmounts: ['1x', '10x', '15x', '30x', '50x', 'Max'],
            currentBuyIndex: 0,
            theme: 'dark',
            shipLimit: 10,
            totalTrades: 0,
            totalEarnings: 0,
            totalUpgrades: 0,
            lastSaveTime: Date.now(),
            timePlayed: 0,
            employees: {
                storage: {
                    level: 0,
                    cost: 1000
                },
                efficiency: {
                    level: 0,
                    cost: 1500
                },
                security: {
                    level: 0,
                    cost: 2000
                }
            },
            shareCooldown: {
                lastShareTime: 0,
                cooldownDuration: 1920 // 32 minutes in seconds
            },
            rebirthCooldown: {
                lastRebirthTime: 0,
                cooldownDuration: 604800 // 7 days in seconds
            },
            securityProtection: 0,
            version: "v2.0.0",
            shipIdCounter: 1
        };

        const MAX_SHIP_LIMIT = 100;
        const MAX_EMPLOYEE_LEVEL = 10;
        const MAX_TRADER_LEVEL = 1000;
        const MIN_TRADE_DURATION = 5;
        const MAX_EARNINGS_PER_TRADE = 1e12; // Example cap

        const VERSION = "v2.0.0";

        // ==================== INITIALIZATION ====================
        function initialize() {
            loadGame();
            updateDisplay();
            startTimeCounter();
            renderShips();
            updateUpgradeMenu();
            updateEmployeeMenu();
        }

        window.onload = initialize;

        // ==================== SAVE & LOAD ====================
        function saveGame() {
            gameState.lastSaveTime = Date.now();
            try {
                localStorage.setItem('interstellarTraderSave', JSON.stringify(gameState));
            } catch (e) {
                console.error("Save failed:", e);
                logEvent("‚ö† Save failed due to browser restrictions.");
            }
        }

        function loadGame() {
            const savedState = localStorage.getItem('interstellarTraderSave');
            if (savedState) {
                gameState = JSON.parse(savedState);
                migrateGameState();
                handleOfflineProgress();
                updateTheme();
                updateDisplay();
            } else {
                // Initialize first ship
                addShip(gameState.shipIdCounter);
                saveGame();
            }
        }

        function migrateGameState() {
            if (!gameState.version || gameState.version !== VERSION) {
                // Handle migration if needed
                gameState.version = VERSION;
                saveGame();
            }
            // Initialize missing properties if necessary
            if (!gameState.ships || gameState.ships.length === 0) {
                addShip(gameState.shipIdCounter);
            }
            if (gameState.shipIdCounter === undefined) {
                gameState.shipIdCounter = gameState.ships.length > 0 ? Math.max(...gameState.ships.map(s => s.id)) : 1;
            }
        }

        // ==================== TIME MANAGEMENT ====================
        let timeCounterInterval = null;

        function startTimeCounter() {
            if (!timeCounterInterval) {
                timeCounterInterval = setInterval(() => {
                    gameState.timePlayed += 1;
                }, 1000);
            }
        }

        function stopTimeCounter() {
            if (timeCounterInterval) {
                clearInterval(timeCounterInterval);
                timeCounterInterval = null;
            }
        }

        // ==================== DISPLAY UPDATE ====================
        function updateDisplay() {
            document.getElementById('credits').innerText = `${formatNumber(gameState.credits)} üí∏`;
            document.getElementById('spaceship-display').innerText = `Spaceships: ${gameState.ships.length}/${formatNumber(gameState.shipLimit)} üöÄ`;
            document.getElementById('tech-level-display').innerText = `Technology Level: ${formatNumber(gameState.techLevel)} ‚ú®`;
            document.getElementById('rebirth-points').innerText = gameState.rebirthPoints;
            document.getElementById('buy-amount-button').innerText = `Buy: ${gameState.buyAmounts[gameState.currentBuyIndex]}`;

            // Update action buttons
            const combineAllButton = document.getElementById('combine-all-button');
            if (combineAllButton) {
                combineAllButton.disabled = gameState.ships.length <= 1;
            }

            // Update upgrade menu costs
            updateUpgradeMenu();
            updateEmployeeMenu();
        }

        function formatNumber(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(2).replace(/\.00$/, '') + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2).replace(/\.00$/, '') + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2).replace(/\.00$/, '') + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2).replace(/\.00$/, '') + 'K';
            return num.toString();
        }

        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hrs}h ${mins}m ${secs}s`;
        }

        // ==================== EVENT LOG ====================
        function logEvent(message) {
            const eventLog = document.getElementById('event-log');
            const p = document.createElement('p');
            const timestamp = new Date().toLocaleTimeString();
            p.innerText = `[${timestamp}] ${message}`;
            eventLog.appendChild(p);

            // Limit to last 100 entries
            while (eventLog.children.length > 100) {
                eventLog.removeChild(eventLog.firstChild);
            }

            eventLog.scrollTop = eventLog.scrollHeight;
        }

        // ==================== SHIP MANAGEMENT ====================
        function addShip(shipId, traderLevel = 1, upgrades = 0, automation = false) {
            const ship = {
                id: shipId,
                upgrades: upgrades,
                traderLevel: traderLevel,
                trading: false,
                automation: automation,
                intervalId: null
            };
            gameState.ships.push(ship);
            renderShip(ship);
        }

        function renderShips() {
            const shipContainer = document.getElementById('ship-container');
            shipContainer.innerHTML = '';
            gameState.ships.forEach(ship => {
                renderShip(ship);
            });
        }

        function renderShip(ship) {
            const shipDiv = document.createElement('div');
            shipDiv.classList.add('ship');
            shipDiv.id = `ship-${ship.id}`;
            if (ship.automation) {
                shipDiv.classList.add('automation');
            }
            // Apply current theme
            if (gameState.theme === 'light') {
                shipDiv.classList.add('light-theme');
            } else if (gameState.theme === 'blue') {
                shipDiv.classList.add('blue-theme');
            }
            shipDiv.innerHTML = `
                <div class="upgrade-count">üîº ${ship.upgrades}</div>
                <span>üöÄ Ship ${ship.id}</span>
                <p>Trader Level: <span id="trader-level-${ship.id}">${ship.traderLevel}</span></p>
                <div class="progress-bar">
                    <div class="progress" id="progress-${ship.id}"></div>
                    <span class="progress-time" id="progress-time-${ship.id}">10s</span>
                    <span class="progress-earnings" id="progress-earnings-${ship.id}">0 üí∏</span>
                </div>
                <button class="button upgrade-trader-button" onclick="buyBetterTrader(${ship.id})">Upgrade Trader</button>
                <div class="automation-indicator" title="Automated Trading">ü§ñ</div>
            `;
            shipDiv.addEventListener('click', function(event) {
                if (!event.target.classList.contains('button') && !event.target.classList.contains('upgrade-trader-button') && !event.target.classList.contains('automation-indicator')) {
                    startTrade(ship.id);
                }
            });
            // Prevent click events on buttons from bubbling up
            shipDiv.querySelectorAll('.button, .automation-indicator').forEach(element => {
                element.addEventListener('click', function(event) {
                    event.stopPropagation();
                });
            });
            document.getElementById('ship-container').appendChild(shipDiv);
        }

        function buyShip() {
            if (gameState.ships.length >= gameState.shipLimit) {
                logEvent(`‚ö† You've reached the maximum number of ships (${formatNumber(gameState.shipLimit)}). Upgrade to add more.`);
                return;
            }
            const cost = Math.floor(80 * Math.pow(1.15, gameState.ships.length));
            if (gameState.credits >= cost) {
                gameState.credits -= cost;
                gameState.shipIdCounter += 1;
                addShip(gameState.shipIdCounter);
                logEvent(`üöÄ You bought a new spaceship! Total spaceships: ${gameState.ships.length}`);
                updateDisplay();
                saveGame();
            } else {
                logEvent(`‚ö† Not enough credits to buy a new ship! (Cost: ${formatNumber(cost)} Credits)`);
            }
        }

        // ==================== TRADE MANAGEMENT ====================
        function startTrade(shipId) {
            const ship = gameState.ships.find(s => s.id === shipId);
            if (!ship || ship.trading) return;

            const progressBar = document.getElementById(`progress-${ship.id}`);
            const progressTime = document.getElementById(`progress-time-${ship.id}`);
            const progressEarnings = document.getElementById(`progress-earnings-${ship.id}`);
            if (!progressBar || !progressTime || !progressEarnings) {
                console.error(`‚ö† Unable to start trade for Ship ${ship.id}.`);
                return;
            }

            progressBar.style.width = '0%';
            ship.trading = true;

            let progress = 0;
            let tradeDuration = 10; // base trade duration in seconds

            // Apply Efficiency Employee bonus
            const efficiencyBonus = gameState.employees.efficiency.level;
            tradeDuration -= efficiencyBonus;

            // Apply Upgrades
            const upgradeBonus = Math.floor(ship.upgrades / 5);
            tradeDuration -= upgradeBonus;

            // Enforce minimum trade duration
            tradeDuration = Math.max(MIN_TRADE_DURATION, tradeDuration);

            const intervalTime = 1000; // 1 second intervals

            const progressInterval = setInterval(() => {
                progress++;
                const percentage = (progress / tradeDuration) * 100;
                progressBar.style.width = percentage + '%';
                progressTime.innerText = `${tradeDuration - progress}s`;
                const earnings = Math.floor(50 * gameState.techLevel * ship.traderLevel * gameState.multiplier);
                progressEarnings.innerText = `${formatNumber(earnings)} üí∏`;

                if (progress >= tradeDuration) {
                    clearInterval(progressInterval);
                    ship.trading = false;
                    ship.intervalId = null;
                    gameState.credits += earnings;
                    gameState.totalCreditsEarned += earnings;
                    gameState.totalEarnings += earnings;
                    gameState.totalTrades += 1;
                    logEvent(`‚ú® Ship ${ship.id} completed a trade mission and earned ${formatNumber(earnings)} credits!`);
                    updateDisplay();
                    randomEvent();
                    progressBar.style.width = '0%';
                    progressTime.innerText = `${tradeDuration}s`;
                    progressEarnings.innerText = `0 üí∏`;
                    saveGame();
                    // If automation is enabled, start the next trade automatically
                    if (ship.automation) {
                        setTimeout(() => {
                            startTrade(ship.id);
                        }, 1000);
                    }
                }
            }, intervalTime);
            ship.intervalId = progressInterval;
        }

        function sendAllShips() {
            gameState.ships.forEach(ship => {
                if (!ship.trading) {
                    startTrade(ship.id);
                }
            });
            logEvent(`‚öôÔ∏è All ships have been sent to trade missions.`);
            updateDisplay();
            saveGame();
        }

        // ==================== UPGRADE MANAGEMENT ====================
        function toggleUpgradeMenu() {
            const modal = document.getElementById('upgrade-menu');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                closeAllModals();
                modal.style.display = 'block';
                updateUpgradeMenu();
            }
        }

        function updateUpgradeMenu() {
            // Update costs
            const upgradeCost = calculateUpgradeCost();
            const automationCost = calculateAutomationCost();
            const multiplierCost = calculateMultiplierCost();
            const bigUpgradeCost = calculateBigUpgradeCost();
            const shipLimitUpgradeCost = calculateShipLimitUpgradeCost();

            document.getElementById('upgrade-cost').innerText = `${formatNumber(upgradeCost)} üí∏`;
            document.getElementById('automation-cost').innerText = `${formatNumber(automationCost)} üí∏`;
            document.getElementById('multiplier-cost').innerText = `${formatNumber(multiplierCost)} üí∏`;
            document.getElementById('big-upgrade-cost').innerText = `${formatNumber(bigUpgradeCost)} üí∏`;
            document.getElementById('ship-limit-upgrade-cost').innerText = `${formatNumber(shipLimitUpgradeCost)} üí∏`;
        }

        function calculateUpgradeCost() {
            return Math.floor(100 * Math.pow(1.2, gameState.techLevel - 1));
        }

        function calculateAutomationCost() {
            const automationCount = gameState.ships.filter(s => s.automation).length;
            return Math.floor(500 * Math.pow(1.2, automationCount));
        }

        function calculateMultiplierCost() {
            return Math.floor(10000 * Math.pow(1.5, gameState.multiplier - 1));
        }

        function calculateBigUpgradeCost() {
            return Math.floor(5000 * Math.pow(1.2, gameState.techLevel - 1));
        }

        function calculateShipLimitUpgradeCost() {
            return Math.floor(500 * Math.pow(1.5, (gameState.shipLimit - 10) / 10));
        }

        function buyUpgrade() {
            const cost = calculateUpgradeCost();
            if (gameState.credits >= cost) {
                gameState.credits -= cost;
                gameState.techLevel += 1;
                gameState.totalUpgrades += 1;
                logEvent(`üîß Technology level increased to ${formatNumber(gameState.techLevel)}.`);
                updateDisplay();
                saveGame();
            } else {
                logEvent(`‚ö† Not enough credits to buy upgrade! (Cost: ${formatNumber(cost)} Credits)`);
            }
        }

        function buyAutomation() {
            const automationCount = gameState.ships.filter(s => s.automation).length;
            if (automationCount >= gameState.ships.length) {
                logEvent(`‚ö† All ships already have automation.`);
                return;
            }
            const cost = calculateAutomationCost();
            if (gameState.credits >= cost) {
                gameState.credits -= cost;
                const nextShip = gameState.ships.find(s => !s.automation);
                nextShip.automation = true;
                logEvent(`ü§ñ Automation purchased for Ship ${nextShip.id}!`);
                updateDisplay();
                saveGame();
                if (!nextShip.trading) {
                    startTrade(nextShip.id);
                }
            } else {
                logEvent(`‚ö† Not enough credits to buy automation! (Cost: ${formatNumber(cost)} Credits)`);
            }
        }

        function buyMultiplier() {
            const cost = calculateMultiplierCost();
            if (gameState.credits >= cost) {
                gameState.credits -= cost;
                gameState.multiplier += 1;
                gameState.totalUpgrades += 1;
                logEvent(`‚úñÔ∏è Multiplier increased to x${gameState.multiplier}.`);
                updateDisplay();
                saveGame();
            } else {
                logEvent(`‚ö† Not enough credits to buy multiplier! (Cost: ${formatNumber(cost)} Credits)`);
            }
        }

        function buyBigUpgrade() {
            const cost = calculateBigUpgradeCost();
            if (gameState.credits >= cost) {
                openBigUpgradeModal();
            } else {
                logEvent(`‚ö† Not enough credits to buy Big Upgrade! (Cost: ${formatNumber(cost)} Credits)`);
            }
        }

        function upgradeShipLimit() {
            const cost = calculateShipLimitUpgradeCost();
            if (gameState.shipLimit >= MAX_SHIP_LIMIT) {
                logEvent(`‚ö† You've reached the maximum ship limit of ${formatNumber(MAX_SHIP_LIMIT)}.`);
                return;
            }
            if (gameState.credits >= cost) {
                gameState.credits -= cost;
                gameState.shipLimit += 10;
                logEvent(`üìà Ship limit increased by 10 to ${formatNumber(gameState.shipLimit)}.`);
                updateDisplay();
                saveGame();
            } else {
                logEvent(`‚ö† Not enough credits to upgrade ship limit! (Cost: ${formatNumber(cost)} Credits)`);
            }
        }

        function buyBetterTrader(shipId) {
            const ship = gameState.ships.find(s => s.id === shipId);
            if (!ship) {
                console.error(`‚ö† Ship ${shipId} not found.`);
                return;
            }
            const buyAmount = getBuyAmountMultiplier();
            let totalUpgrades = 0;
            let totalCost = 0;

            if (buyAmount === 'Max') {
                while (true) {
                    const cost = Math.floor(10 * Math.pow(1.5, ship.upgrades + totalUpgrades));
                    if (gameState.credits >= totalCost + cost && ship.traderLevel + totalUpgrades < MAX_TRADER_LEVEL) {
                        totalCost += cost;
                        totalUpgrades += 1;
                    } else {
                        break;
                    }
                }
            } else {
                for (let i = 0; i < buyAmount; i++) {
                    const cost = Math.floor(10 * Math.pow(1.5, ship.upgrades + totalUpgrades));
                    if (gameState.credits >= totalCost + cost && ship.traderLevel + totalUpgrades < MAX_TRADER_LEVEL) {
                        totalCost += cost;
                        totalUpgrades += 1;
                    } else {
                        break;
                    }
                }
            }

            if (totalUpgrades > 0 && gameState.credits >= totalCost) {
                gameState.credits -= totalCost;
                ship.traderLevel += totalUpgrades;
                ship.upgrades += totalUpgrades;
                gameState.totalUpgrades += totalUpgrades;
                document.getElementById(`trader-level-${ship.id}`).innerText = ship.traderLevel;
                logEvent(`üîº Ship ${ship.id} trader level increased by x${totalUpgrades} to ${ship.traderLevel}.`);
                updateDisplay();
                saveGame();
            } else {
                logEvent(`‚ö† Not enough credits or reached max trader level!`);
            }
        }

        function getBuyAmountMultiplier() {
            const multiplierText = gameState.buyAmounts[gameState.currentBuyIndex];
            if (multiplierText === 'Max') {
                return 'Max';
            }
            return parseInt(multiplierText.replace('x', ''));
        }

        function toggleBuyAmount() {
            gameState.currentBuyIndex = (gameState.currentBuyIndex + 1) % gameState.buyAmounts.length;
            document.getElementById('buy-amount-button').innerText = `Buy: ${gameState.buyAmounts[gameState.currentBuyIndex]}`;
            saveGame();
        }

        // ==================== EMPLOYEE MANAGEMENT ====================
        function toggleEmployeeMenu() {
            const modal = document.getElementById('employee-menu');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                closeAllModals();
                modal.style.display = 'block';
                updateEmployeeMenu();
            }
        }

        function updateEmployeeMenu() {
            const storageCost = calculateEmployeeCost('storage');
            const efficiencyCost = calculateEmployeeCost('efficiency');
            const securityCost = calculateEmployeeCost('security');

            document.getElementById('storage-employee-cost').innerText = `${formatNumber(storageCost)} üí∏`;
            document.getElementById('efficiency-employee-cost').innerText = `${formatNumber(efficiencyCost)} üí∏`;
            document.getElementById('security-employee-cost').innerText = `${formatNumber(securityCost)} üí∏`;
        }

        function calculateEmployeeCost(type) {
            const employee = gameState.employees[type];
            return Math.ceil(employee.cost * Math.pow(1.2, employee.level));
        }

        function hireEmployee(type) {
            const employee = gameState.employees[type];
            if (!employee) {
                console.error(`‚ö† Invalid employee type: ${type}.`);
                return;
            }
            if (employee.level >= MAX_EMPLOYEE_LEVEL) {
                logEvent(`‚ö† You have reached the maximum level for ${capitalize(type)} Employees.`);
                return;
            }
            const cost = calculateEmployeeCost(type);
            if (gameState.credits >= cost) {
                gameState.credits -= cost;
                employee.level += 1;
                logEvent(`üë®‚ÄçüöÄ Hired a Level ${employee.level} ${capitalize(type)} Employee!`);
                applyEmployeeBenefits(type);
                updateDisplay();
                saveGame();
            } else {
                logEvent(`‚ö† Not enough credits to hire ${capitalize(type)} employee! (Cost: ${formatNumber(cost)} Credits)`);
            }
        }

        function applyEmployeeBenefits(type) {
            switch(type) {
                case 'storage':
                    gameState.shipLimit += 2;
                    logEvent(`üì¶ Storage Employee increased ship limit to ${formatNumber(gameState.shipLimit)}.`);
                    break;
                case 'efficiency':
                    // No immediate action; benefit applied during trade calculations
                    logEvent(`‚öôÔ∏è Efficiency Employee improved trade efficiency.`);
                    break;
                case 'security':
                    gameState.securityProtection += 10;
                    logEvent(`üõ°Ô∏è Security Employee increased protection to ${gameState.securityProtection}%.`);
                    break;
                default:
                    break;
            }
        }

        // ==================== COMBINE SHIPS ====================
        function toggleCombineShipsModal() {
            const modal = document.getElementById('combine-ships-modal');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                closeAllModals();
                modal.style.display = 'block';
                populateCombineShips();
            }
        }

        function populateCombineShips() {
            const selectionDiv = document.getElementById('combine-ship-selection');
            selectionDiv.innerHTML = '';
            gameState.ships.forEach(ship => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `combine-ship-${ship.id}`;
                checkbox.value = ship.id;
                const label = document.createElement('label');
                label.htmlFor = `combine-ship-${ship.id}`;
                label.innerText = `Ship ${ship.id} (Trader Level: ${ship.traderLevel})`;
                const br = document.createElement('br');
                selectionDiv.appendChild(checkbox);
                selectionDiv.appendChild(label);
                selectionDiv.appendChild(br);
            });
        }

        function confirmCombineShips() {
            const selectedCheckboxes = Array.from(document.querySelectorAll('#combine-ship-selection input[type="checkbox"]:checked'));
            if (selectedCheckboxes.length !== 2) {
                logEvent(`‚ö† Please select exactly two ships to combine.`);
                return;
            }
            const shipId1 = parseInt(selectedCheckboxes[0].value);
            const shipId2 = parseInt(selectedCheckboxes[1].value);
            const ship1 = gameState.ships.find(s => s.id === shipId1);
            const ship2 = gameState.ships.find(s => s.id === shipId2);
            if (!ship1 || !ship2) {
                logEvent(`‚ö† Invalid ships selected for combination.`);
                return;
            }
            const totalUpgrades = ship1.upgrades + ship2.upgrades;
            const newTraderLevel = ship1.traderLevel + ship2.traderLevel;
            const mergeCost = Math.max(Math.floor(totalUpgrades / 6), 10); // Minimum cost of 10 credits

            if (gameState.credits >= mergeCost) {
                // Remove the old ships
                gameState.ships = gameState.ships.filter(s => s.id !== shipId1 && s.id !== shipId2);
                // Clear intervals
                clearInterval(ship1.intervalId);
                clearInterval(ship2.intervalId);
                // Add the new combined ship
                gameState.shipIdCounter += 1;
                const newShip = {
                    id: gameState.shipIdCounter,
                    upgrades: 0,
                    traderLevel: newTraderLevel,
                    trading: false,
                    automation: ship1.automation || ship2.automation,
                    intervalId: null
                };
                gameState.ships.push(newShip);
                gameState.credits -= mergeCost;
                logEvent(`üîó Combined Ship ${shipId1} and Ship ${shipId2} into Ship ${newShip.id} with Trader Level ${newShip.traderLevel}. (Cost: ${formatNumber(mergeCost)} Credits)`);
                updateDisplay();
                renderShips();
                toggleCombineShipsModal();
                saveGame();
            } else {
                logEvent(`‚ö† Not enough credits to combine ships! (Cost: ${formatNumber(mergeCost)} Credits)`);
            }
        }

        function toggleCombineAllShipsModal() {
            if (gameState.ships.length <= 1) {
                logEvent(`‚ö† Not enough ships to combine.`);
                return;
            }
            const modal = document.getElementById('combine-all-ships-modal');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                closeAllModals();
                modal.style.display = 'block';
                const totalUpgrades = gameState.ships.reduce((acc, ship) => acc + ship.upgrades, 0);
                const combineAllCost = Math.max(Math.floor(totalUpgrades / 4), 10); // Minimum cost of 10 credits
                document.getElementById('combine-all-cost').innerText = `${formatNumber(combineAllCost)} üí∏`;
            }
        }

        function confirmCombineAllShips() {
            if (gameState.ships.length <= 1) {
                logEvent(`‚ö† Not enough ships to combine.`);
                return;
            }
            const totalUpgrades = gameState.ships.reduce((acc, ship) => acc + ship.upgrades, 0);
            const newTraderLevel = gameState.ships.reduce((acc, ship) => acc + ship.traderLevel, 0);
            const mergeCost = Math.max(Math.floor(totalUpgrades / 4), 10); // Minimum cost of 10 credits

            if (gameState.credits >= mergeCost) {
                // Clear intervals
                gameState.ships.forEach(ship => {
                    clearInterval(ship.intervalId);
                });
                // Remove all existing ships
                gameState.ships = [];
                // Add the new combined ship
                gameState.shipIdCounter += 1;
                const newShip = {
                    id: gameState.shipIdCounter,
                    upgrades: 0,
                    traderLevel: newTraderLevel,
                    trading: false,
                    automation: true,
                    intervalId: null
                };
                gameState.ships.push(newShip);
                gameState.credits -= mergeCost;
                logEvent(`üîó Combined all ships into Ship ${newShip.id} with Trader Level ${newShip.traderLevel}. (Cost: ${formatNumber(mergeCost)} Credits)`);
                updateDisplay();
                renderShips();
                toggleCombineAllShipsModal();
                saveGame();
            } else {
                logEvent(`‚ö† Not enough credits to combine all ships! (Cost: ${formatNumber(mergeCost)} Credits)`);
            }
        }

        // ==================== BIG UPGRADE ====================
        function openBigUpgradeModal() {
            const modal = document.getElementById('big-upgrade-modal');
            const select = document.getElementById('big-upgrade-ship-select');
            select.innerHTML = gameState.ships.map(ship => `<option value="${ship.id}">Ship ${ship.id}</option>`).join('');
            modal.style.display = 'block';
        }

        function closeBigUpgradeModal() {
            const modal = document.getElementById('big-upgrade-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function confirmBigUpgrade() {
            const select = document.getElementById('big-upgrade-ship-select');
            const shipId = parseInt(select.value);
            const ship = gameState.ships.find(s => s.id === shipId);
            if (!ship) {
                logEvent(`‚ö† Ship ${shipId} not found for Big Upgrade.`);
                return;
            }
            const cost = calculateBigUpgradeCost();
            if (gameState.credits >= cost) {
                gameState.credits -= cost;
                ship.traderLevel *= 2;
                ship.upgrades += 1;
                gameState.totalUpgrades += 1;
                document.getElementById(`trader-level-${ship.id}`).innerText = ship.traderLevel;
                logEvent(`üöÄ Big Upgrade applied to Ship ${ship.id}! Trader level doubled to ${ship.traderLevel}.`);
                updateDisplay();
                closeBigUpgradeModal();
                saveGame();
            } else {
                logEvent(`‚ö† Not enough credits to apply Big Upgrade to Ship ${shipId}! (Cost: ${formatNumber(cost)} Credits)`);
            }
        }

        // ==================== RANDOM EVENTS ====================
        function randomEvent() {
            let eventChance = Math.random();
            if (eventChance < 0.2) { // 20% chance
                let eventType = Math.floor(Math.random() * 3);
                switch (eventType) {
                    case 0:
                        // Alien attack
                        const protection = gameState.securityProtection || 0;
                        if (Math.random() * 100 < (100 - protection)) {
                            logEvent(`üí• An alien attack! You lost 50 credits to defend yourself.`);
                            gameState.credits -= Math.min(50, gameState.credits);
                            gameState.totalEarnings = Math.max(0, gameState.totalEarnings - 50);
                        } else {
                            logEvent(`üõ°Ô∏è Security Employee protected you from an alien attack! No credits lost.`);
                        }
                        break;
                    case 1:
                        // Meteor shower
                        logEvent(`‚òÑÔ∏è‚ú® Meteor shower! Your ships earned a bonus.`);
                        const bonus = Math.floor(25 * gameState.techLevel * gameState.multiplier * gameState.ships.length);
                        gameState.credits += bonus;
                        gameState.totalCreditsEarned += bonus;
                        gameState.totalEarnings += bonus;
                        logEvent(`‚ú® Bonus: Earned an extra ${formatNumber(bonus)} credits from meteor shower.`);
                        break;
                    case 2:
                        // Galactic fair
                        logEvent(`üéâ Galactic fair! You made a deal and earned bonus credits.`);
                        gameState.credits += 100;
                        gameState.totalCreditsEarned += 100;
                        gameState.totalEarnings += 100;
                        break;
                }
                updateDisplay();
                saveGame();
            }
        }

        // ==================== REBIRTH SYSTEM ====================
        function confirmRebirth() {
            const requiredCredits = 100000;
            if (gameState.credits >= requiredCredits) {
                const currentTime = Math.floor(Date.now() / 1000);
                const elapsed = currentTime - gameState.rebirthCooldown.lastRebirthTime;
                if (elapsed < gameState.rebirthCooldown.cooldownDuration) {
                    const remaining = gameState.rebirthCooldown.cooldownDuration - elapsed;
                    logEvent(`‚ö† Rebirth is on cooldown. Please wait ${formatTime(remaining)} before rebirthing again.`);
                    return;
                }
                const pointsEarned = Math.floor(gameState.totalCreditsEarned / 100000);
                if (pointsEarned < 1) {
                    logEvent(`‚ö† Not enough total credits to rebirth!`);
                    return;
                }
                document.getElementById('rebirth-modal-text').innerHTML = `Are you sure you want to rebirth? This will reset all your progress but grant you <strong>${pointsEarned}</strong> Rebirth Points (RP).`;
                openRebirthModal();
            } else {
                logEvent(`‚ö† Not enough credits to rebirth! (Requires ${formatNumber(requiredCredits)} Credits)`);
            }
        }

        function openRebirthModal() {
            closeAllModals();
            const modal = document.getElementById('rebirth-modal');
            modal.style.display = 'block';
        }

        function closeRebirthModal() {
            const modal = document.getElementById('rebirth-modal');
            modal.style.display = 'none';
        }

        function rebirth() {
            const requiredCredits = 100000;
            if (gameState.credits >= requiredCredits) {
                const currentTime = Math.floor(Date.now() / 1000);
                const elapsed = currentTime - gameState.rebirthCooldown.lastRebirthTime;
                if (elapsed < gameState.rebirthCooldown.cooldownDuration) {
                    const remaining = gameState.rebirthCooldown.cooldownDuration - elapsed;
                    logEvent(`‚ö† Rebirth is on cooldown. Please wait ${formatTime(remaining)} before rebirthing again.`);
                    return;
                }
                const pointsEarned = Math.floor(gameState.totalCreditsEarned / 100000);
                if (pointsEarned < 1) {
                    logEvent(`‚ö† Not enough total credits to rebirth!`);
                    return;
                }
                gameState.rebirthPoints += pointsEarned;
                // Reset game state
                gameState.credits = 100;
                gameState.techLevel = 1;
                gameState.totalCreditsEarned = 100;
                gameState.multiplier = 1;
                gameState.shipLimit = 10;
                gameState.totalTrades = 0;
                gameState.totalEarnings = 0;
                gameState.totalUpgrades = 0;
                gameState.currentBuyIndex = 0;
                gameState.employees = {
                    storage: { level: 0, cost: 1000 },
                    efficiency: { level: 0, cost: 1500 },
                    security: { level: 0, cost: 2000 }
                };
                gameState.securityProtection = 0;
                gameState.timePlayed = 0;
                gameState.ships.forEach(ship => {
                    clearInterval(ship.intervalId);
                });
                gameState.ships = [];
                gameState.shipIdCounter = 1;
                addShip(gameState.shipIdCounter);
                // Set rebirth cooldown
                gameState.rebirthCooldown.lastRebirthTime = currentTime;
                logEvent(`‚ôªÔ∏è You have rebirthed! Earned ${pointsEarned} Rebirth Points.`);
                updateDisplay();
                renderShips();
                closeRebirthModal();
                saveGame();
            } else {
                logEvent(`‚ö† Not enough credits to rebirth! (Requires ${formatNumber(requiredCredits)} Credits)`);
            }
        }

        // ==================== SHARE FEATURE ====================
        function shareGame() {
            const currentTime = Math.floor(Date.now() / 1000);
            const elapsed = currentTime - gameState.shareCooldown.lastShareTime;
            if (elapsed < gameState.shareCooldown.cooldownDuration) {
                const remaining = gameState.shareCooldown.cooldownDuration - elapsed;
                logEvent(`‚ö† Share bonus is on cooldown. Please wait ${formatTime(remaining)} before sharing again.`);
                return;
            }
            openShareModal();
        }

        function openShareModal() {
            closeAllModals();
            const modal = document.getElementById('share-modal');
            modal.style.display = 'block';
        }

        function closeShareModal() {
            const modal = document.getElementById('share-modal');
            modal.style.display = 'none';
        }

        function copyShareLink() {
            const shareLink = document.getElementById('share-link');
            shareLink.select();
            shareLink.setSelectionRange(0, 99999);
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    grantShareReward();
                    saveGame();
                } else {
                    logEvent(`‚ö† Failed to copy the game link.`);
                }
            } catch (err) {
                console.error('Failed to copy:', err);
                logEvent(`‚ö† Failed to copy the game link.`);
            }
            closeShareModal();
        }

        function grantShareReward() {
            gameState.credits += 500;
            gameState.totalCreditsEarned += 500;
            gameState.totalEarnings += 500;
            gameState.shareCooldown.lastShareTime = Math.floor(Date.now() / 1000);
            updateDisplay();
            logEvent(`üìã Share successful! Earned 500 Credits.`);
        }

        // ==================== SETTINGS ====================
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                closeAllModals();
                modal.style.display = 'block';
            }
        }

        function toggleTheme() {
            if (gameState.theme === 'dark') {
                gameState.theme = 'light';
            } else if (gameState.theme === 'light') {
                gameState.theme = 'blue';
            } else {
                gameState.theme = 'dark';
            }
            updateTheme();
            saveGame();
        }

        function updateTheme() {
            document.body.className = '';
            document.getElementById('game-header').className = '';
            document.getElementById('event-log').className = '';
            if (gameState.theme === 'light') {
                document.body.classList.add('light-theme');
                document.getElementById('game-header').classList.add('light-theme');
                document.getElementById('event-log').classList.add('light-theme');
            } else if (gameState.theme === 'blue') {
                document.body.classList.add('blue-theme');
                document.getElementById('game-header').classList.add('blue-theme');
                document.getElementById('event-log').classList.add('blue-theme');
            }
            // Update modals
            document.querySelectorAll('.modal-content').forEach(modal => {
                modal.className = 'modal-content';
                if (gameState.theme === 'light') {
                    modal.classList.add('light-theme');
                } else if (gameState.theme === 'blue') {
                    modal.classList.add('blue-theme');
                }
            });
            // Update ships
            document.querySelectorAll('.ship').forEach(ship => {
                ship.className = 'ship';
                if (gameState.theme === 'light') {
                    ship.classList.add('light-theme');
                } else if (gameState.theme === 'blue') {
                    ship.classList.add('blue-theme');
                }
            });
        }

        function saveGameManually() {
            saveGame();
            alert("üíæ Game has been saved!");
        }

        function resetGame() {
            if (confirm("Are you sure you want to reset the game? This action cannot be undone.")) {
                localStorage.removeItem('interstellarTraderSave');
                location.reload();
            }
        }

        // ==================== HELP ====================
        function toggleHelp() {
            const modal = document.getElementById('help-modal');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                closeAllModals();
                modal.style.display = 'block';
            }
        }

        // ==================== UTILITIES ====================
        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function handleOfflineProgress() {
            const currentTime = Date.now();
            const offlineTime = Math.floor((currentTime - gameState.lastSaveTime) / 1000);
            if (offlineTime > 0) {
                const earnings = Math.floor(50 * gameState.techLevel * gameState.multiplier * gameState.ships.length * (offlineTime / 10));
                gameState.credits += earnings;
                gameState.totalCreditsEarned += earnings;
                gameState.totalEarnings += earnings;
                logEvent(`‚è∞ You were offline for ${formatTime(offlineTime)} and earned ${formatNumber(earnings)} credits.`);
                updateDisplay();
            }
        }
    </script>
</body>
</html>
